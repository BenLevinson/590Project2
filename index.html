<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        canvas {
            border: 5px solid black;
            display: block;
            margin-left: auto;
            margin-right: auto;
            background-color: white;
        }
        body {
            background-color: grey;
            text-align: center;
        }
        #title {
            font-family: "Comic Sans MS";
            font-size: 40px;
            margin-bottom: 10px;
            position: relative;
            bottom: 15px;
        }
    </style>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/babel" >
        "use strict";
        let canvas;
        let ctx;
        let socket; 
        let color;
        let prevColor;
        let hash;
        let moveLeft;
        let moveRight;
        let moveUp;
        let moveDown;
        let users = {};
        let leftKey = 37;
        let upKey = 38;
        let rightKey = 39;
        let downKey = 40;
        let aKey = 65;
        let dKey = 68;
        let sKey = 83;
        let wKey = 87;

        const createUser = (data) => {
            hash = data.hash;
            users[hash] = data;
            requestAnimationFrame(draw);
            console.log(users[hash]);
        }
        
        const removeUser = (data) => {
            if(users[data]) 
                delete users[data];
        };

        const update = (data) => {
            if(!users[data.user.hash]) {
                users[data.user.hash] = data.user;
                return;
            }
            const user = users[data.user.hash];
            if(user.lastUpdate >= data.user.lastUpdate) {
                return;
            }

            user.lastUpdate = data.user.lastUpdate;
            user.prevX = data.user.prevX;
            user.prevY = data.user.prevY;
            user.destX = data.user.destX;
            user.destY = data.user.destY;
            user.alpha = 0.05;
            
            if(data.dir === 'left') {
                user.destX -= data.val;
            }
            else if(data.dir === 'right') {
                user.destX += data.val;
            }
            else if(data.dir === 'up') {
                user.destY -= data.val;
            }
            else if(data.dir === 'down') {
                user.destY += data.val;
            }
            
        };

        const lerp = (v0, v1, alpha) => {
            return (1 - alpha) * v0 + alpha * v1;
        };

        const updatePos = (data) => {
            const user = users[hash];
            let direction = "";
            user.prevX = user.x;
            user.prevY = user.y;
            if(moveLeft) {
                direction = "left";
            }
            if(moveRight) {
                direction = "right";
            }
            if(moveUp) {
                direction = "up";
            }
            if(moveDown) {
                direction = "down";
            }
        
            user.alpha = 0.1;
            socket.emit('moveUpdate', {user: user, dir: direction});
        };
     
        const draw = (data) => {
            updatePos();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const keys = Object.keys(users);
            for(let i = 0; i < keys.length; i++) {
                const user = users[keys[i]];
                if(user.alpha < 1)
                    user.alpha += .05;
                if(user.hash === hash) 
                    ctx.fillStyle = color;   
                else 
                    ctx.fillStyle = 'black';
                user.x = lerp(user.prevX, user.destX, user.alpha);
                user.y = lerp(user.prevY, user.destY, user.alpha);
                ctx.fillRect(user.x, user.y, user.width, user.height);
                
                if(keys.length > 1) {
                    for(let j = i + 1; j < keys.length; j++) {
                        socket.emit('collisionCheck', {user1: users[keys[i]], user2: users[keys[j]]});
                    }
                }
            }
            requestAnimationFrame(draw);
        };
        
        const keyUp = (e) => {
            let key = e.which;
            if(key === aKey || key === leftKey)
                moveLeft = false;
            if(key === dKey || key === rightKey)
                moveRight = false;
            if(key === sKey || key === downKey)
                moveDown = false;
            if(key === wKey || key === upKey)
                moveUp = false;
            
        }
        
        const keyDown = (e) => {
            let key = e.which;
            const user = users[hash];
            if(key === aKey || key === leftKey)
                moveLeft = true;
            if(key === dKey || key === rightKey)
                moveRight = true;
            if(key === sKey || key === downKey)
                moveDown = true;
            if(key === wKey || key === upKey)
                moveUp = true;
                    
            if(moveLeft || moveRight || moveUp || moveDown) {
                e.preventDefault();
            }
        }
        
        const changeColor = () => {           
            color = 'green';
        };

        const changeBack = () => {
            color = prevColor;
        }

        const randomNum = (r) => {
            return Math.floor(Math.random() * r);
        };

        const init = () => {
            canvas = document.querySelector("#canvas");
            ctx = canvas.getContext("2d");
            color = 'rgb('+randomNum(255) + ',' + randomNum(255) + ',' + randomNum(255) +')';
            prevColor = color;
            socket = io.connect();
            socket.on('joined', createUser);
            socket.on('updateMove', update);
            socket.on('collisionDetected', changeColor);
            socket.on('noCollision', changeBack);
            socket.on('disconnect', removeUser);
            document.body.addEventListener('keyup', keyUp);
            document.body.addEventListener('keydown', keyDown);
        };
        window.onload = init;
    </script>
</head>
<body>
    <h1 id="title">Bumper<sup>2</sup></h1>
    <canvas id="canvas" height="800" width="1000">Please use an HTML 5 browser</canvas>
</body>
</html>